Объясню **просто и по делу**, без лишней теории.

---

## Что такое транзакция?

**Транзакция** — это **набор операций с базой данных, который выполняется как единое целое**.

Либо **выполняется всё**, либо **не выполняется ничего**.

Пример (банковский перевод):

1. Списать 100 ₽ со счёта A
2. Зачислить 100 ₽ на счёт B

Это **одна транзакция**.

Если произойдёт ошибка между шагами (сервер упал, ошибка SQL), база:

* **не спишет деньги**
* **не зачислит деньги**
* состояние останется корректным

---

## ACID — это свойства транзакций

**ACID** — набор гарантий, которые СУБД даёт для транзакций.

---

### A — Atomicity (атомарность)

**«Всё или ничего»**

* либо выполняются **все операции**
* либо **ни одна**

```sql
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;
```

Если между `UPDATE` случится ошибка → будет `ROLLBACK`.

---

### C — Consistency (согласованность)

**После транзакции данные корректны по правилам БД**

* соблюдаются:

  * `NOT NULL`
  * `UNIQUE`
  * `FOREIGN KEY`
  * CHECK
  * бизнес-ограничения

Иными словами, **согласованность** — это когда после завершения транзакции  
база данных НЕ может оказаться в состоянии, которое нарушает её правила.

---

### I — Isolation (изоляция)

**Параллельные транзакции не мешают друг другу**

**Представим ситуацию:**

* два пользователя одновременно снимают 80 у.е.
* оба читают старый баланс 100 у.е.
* оба списывают

Изоляция предотвращает такие гонки.

#### Пример:

```sql
START TRANSACTION;

SELECT balance FROM accounts WHERE id = 1;  -- строка НЕ блокируется!
UPDATE accounts SET balance = balance - 80 WHERE id = 1;

COMMIT;

```

#### Решения:

1. Блокировка строки (`FOR UPDATE`)

```sql
START TRANSACTION;

SELECT balance
FROM accounts
WHERE id = 1
FOR UPDATE;

UPDATE accounts
SET balance = balance - 80
WHERE id = 1;

COMMIT;
```

При начале транзакции строка с `FOR UPDATE` блокируется до завершения транзакции.


2. Атомарный `UPDATE` с условием

```sql
START TRANSACTION;

UPDATE accounts
SET balance = balance - 80
WHERE id = 1
  AND balance >= 80;

COMMIT;
```

* Проверка баланса и его изменения происходят за одну операцию
* Первая транзакция завершится, вторая получит баланс < 80 и прервётся

---

### D — Durability (надёжность)

**Если `COMMIT` выполнен — данные не потеряются**

Даже если:

* сервер упал
* питание пропало
* БД перезапустилась

Данные в любом случае восстановятся из журнала транзакций.

---

## Ещё раз "на зачёт"

**ACID** — это:

* **A**tomicity — всё или ничего
* **C**onsistency — данные всегда корректны (и до, и после)
* **I**solation — параллельные операции безопасны
* **D**urability — сохранённое не теряется


Общий алгоритм транзакций:

* **Начало транзакции**. 
  * Начинается после выполнения первого запроса блока транзакций.

* **Фиксация изменений** в случае успеха (`commit`). 
  * Если всё ОК, изменения фиксируются в базе данных.
  
* **Откат изменений** в случае неудачи (`rollbac`k). 
  * Если возникли проблемы, все изменения откатываются до исходного состояния.



