## Техническое задание — Онлайн книжный магазин (учебный проект)

### 1. Цель проекта

* Показать преимущества **SQL**: 
  * структурированные данные, 
  * транзакции, 
  * связи между таблицами.

* Показать преимущества **NoSQL (MongoDB)**: 
  * гибкая структура, 
  * хранение сложных или аналитических данных, 
  * быстрый поиск, 
  * неструктурированные вложенные объекты.

---

### 2. Основные технологии

* **Backend:** FastAPI
* **SQL БД:** PostgreSQL (или MySQL) через SQLAlchemy + транзакции
* **NoSQL БД:** MongoDB через `motor` или `pymongo`
* **Документация:** OpenAPI/Swagger
* **Дополнительно:** Docker Compose для поднятия всех сервисов

---

### 3. SQL — реляционные таблицы

1. **User**

   * `id` (int, PK)
   * `username` (string, уникальное)
   * `email` (string, уникальное)
   * `created_at` (datetime)

2. **Product** (книги)

   * `id` (int, PK)
   * `title` (string)
   * `author` (string)
   * `price` (decimal)
   * `stock` (int, количество на складе)

3. **Order**

   * `id` (int, PK)
   * `user_id` (FK → User.id)
   * `status` (enum: pending, completed, cancelled)
   * `created_at` (datetime)

4. **OrderItem**

   * `id` (int, PK)
   * `order_id` (FK → Order.id)
   * `product_id` (FK → Product.id)
   * `quantity` (int)
   * `price` (decimal, на момент заказа)

5. **Payment**

   * `id` (int, PK)
   * `order_id` (FK → Order.id)
   * `amount` (decimal)
   * `status` (enum: pending, completed, failed)
   * `paid_at` (datetime)

**Пример демонстрации SQL-преимущества:**

* Создание заказа и списание товара из склада в одной **транзакции**.
* Связь Order ↔ OrderItem ↔ Product гарантирует целостность.

---

### 4. MongoDB — гибкие/аналитические данные

Предлагается хранить в MongoDB данные, которые 
* часто меняются, 
* не требуют транзакций 
* и имеют гибкую структуру:

1. **Отзывы о книгах**

   * `_id` (ObjectId)
   * `product_id` (int, id книги из SQL)
   * `user_id` (int, опционально)
   * `username` (string, если нет user_id)
   * `rating` (int, 1–5)
   * `comment` (string)
   * `created_at` (datetime)

2. **История просмотра/рекомендации** (опционально для аналитики)

   * `_id` (ObjectId)
   * `user_id` (int)
   * `viewed_products` (array of {product_id, timestamp})

**Почему MongoDB:**

* Можно хранить вложенные массивы (например, все просмотры пользователя) без сложных JOIN.
* Легко добавлять новые поля (например, теги, лайки) без миграций.
* Быстрые агрегаты, например: рейтинг книги, популярные книги, рекомендации.

---

### 5. Основной функционал API

#### SQL

* Создание пользователя, книги, заказа, оплаты
* Добавление товаров в заказ (транзакция: уменьшаем stock)
* Получение заказов пользователя
* Проверка статуса оплаты

#### MongoDB

* Добавление отзывов на книгу
* Получение всех отзывов книги
* Получение рейтинга книги (агрегация)
* Получение истории просмотров пользователя

---

### 6. Пример сценария, демонстрирующего оба типа БД

1. Пользователь создает заказ → **SQL транзакция**: с
   * создаётся Order и OrderItems, уменьшается stock.

2. Пользователь оплачивает заказ → **SQL транзакция**: 
   * Payment создается и статус Order обновляется.

3. Пользователь оставляет отзыв на книгу → **MongoDB**:
   * создается документ Review с гибкой структурой, 
   * легко добавлять новые поля без изменения схемы SQL.

4. Аналитика: 
   показать топ-5 книг по рейтингу → **MongoDB агрегаты**.

---

### 7. Структура проекта (учебная)


```
project/
├─ app/
│  ├─ db/
│  │  ├─ __init__.py
│  │  ├─ sql/
│  │  │  ├─ __init__.py
│  │  │  ├─ models.py        # SQLAlchemy модели
│  │  │  ├─ database.py      # Подключение к SQL и сессии
│  │  │  └─ crud.py          # Основные функции работы с SQL
│  │  └─ mongo/
│  │     ├─ __init__.py
│  │     ├─ models.py        # Pydantic модели для MongoDB
│  │     ├─ database.py      # Подключение к MongoDB
│  │     └─ crud.py          # Основные функции работы с MongoDB
│  ├─ routers/
│  │  ├─ __init__.py
│  │  ├─ users.py
│  │  ├─ products.py
│  │  ├─ orders.py
│  │  ├─ payments.py
│  │  └─ reviews.py
│  └─ main.py
├─ .env                   # Переменные окружения
└─ docker-compose.yml     # Контейнеры для SQL и MongoDB

```

**В данном случае:**

1. SQL и MongoDB чётко разделены
2. CRUD-функции `db/sql/crud.py` и `db/mongo/crud.py` также разделены по типам БД
3. Легко расширять проект 
   * (например, добавить кеширование с помощью Redis).
4. main.py остаётся чистым, только подключает роутеры и базы.

