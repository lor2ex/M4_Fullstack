### 1. Применение автоматических миграций

До этого моменты мы 

* сначала создавали шаблон миграции (пустую миграцию)
* потом заполняли её собственным кодом
* и затем применяли этот код к БД

Вариант рабочий, но, разумеется, не такой удобный как автоматическое создание миграций.

Давайте попробуем 

* снова переименовать поле `address` в  `city`
* но на этот раз уже с использованием параметра `-autogenerate`:

```bash
alembic revision --autogenerate -m "reverse renaming of columns"
```

Вот, что как Alembic предлагает выполнить это переименование:

```python
def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        'user',
        sa.Column(
            'city', 
            sa.String(length=100), 
            nullable=False),
    )
    op.drop_column('user', 'address')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        'user',
        sa.Column(
            'address',
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_column('user', 'city')
    # ### end Alembic commands ###
```

Как видим, вместо переименования поля предлагается 
* его сначала удалить под старым именем
* а затем добавить под новым

(примерно то же самое у нас было в Django ORM)

### 2. Как быть в подобной ситуации?

Всё очень просто:
1. Обязательно проверять
2. И если надо, исправлять

```python
def upgrade() -> None:
    op.alter_column(
        'user',
        'address',
        new_column_name='city',
        existing_type=sa.String(length=100),
        existing_nullable=True,
    )


def downgrade() -> None:
    op.alter_column(
        'user',
        'city',
        new_column_name='address',
        existing_type=sa.String(length=100),
        existing_nullable=True,
    )
```

### 3. Далее, применяем миграцию

```bash
alembic upgrade head
```

### 4. И проверяем результат

**`./main.py`**

```
Найдено таблиц: ['alembic_version', 'user']

Содержимое таблицы 'alembic_version':
{'version_num': '6930bb8b7e58'}

Содержимое таблицы 'user':
{'id': 1, 'name': 'Alice', 'age': 25, 'email': 'alice@example.com', 'city': 'New York'}
{'id': 2, 'name': 'Bob', 'age': 30, 'email': 'bob@example.com', 'city': 'Los Angeles'}
{'id': 3, 'name': 'Charlie', 'age': 22, 'email': 'charlie@example.com', 'city': 'Chicago'}
{'id': 4, 'name': 'Diana', 'age': 28, 'email': 'diana@example.com', 'city': 'Houston'}
{'id': 5, 'name': 'Eve', 'age': 35, 'email': 'eve@example.com', 'city': 'Miami'}
```

---

### 5. Проверяем, всё в нашей БД соответствует Python-коду после этих изменений

```bash
alembic revision --autogenerate -m "test migration"
```

Как видим, теперь наша БД полностью соответствует ORM:

```python
def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
```

Добавлять Alembic нечего)


### 6. Не забываем удалить тестовую миграцию!