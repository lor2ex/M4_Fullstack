## Что нового и важного случилось в SQLAlchemy 2.0

### 1. Новый стиль API: «2.0-style»

Основное изменение — переход к **явно типизированному, более предсказуемому и современному API**.

#### Было (1.x):

* смешение разных стилей (ORM Query API, Core Select API);
* `session.query()` как основной метод ORM-запросов;
* больше императивного и «магического» поведения.

#### Стало (2.0):

* **единый API для Core и ORM** — через `select()`, `update()`, `insert()`, `delete()`;
* ORM-запросы пишутся так же, как SQL Core запросы;
* весь новый код — «declarative and typed».

**Пример:**
`select(User).filter(User.id == 1)` вместо `session.query(User).filter(...)`

---

### 2. Полный отказ от старого ORM Query API

API вида:

```python
session.query(User)
```

считался «временным компромиссом» ещё в 1.4 и полностью удалён в 2.0.

#### Зачем удалили?

* Query API было трудно типизировать;
* оно дублировало Core API;
* вело к избыточности и путанице.

Теперь ORM основан на **едином стиле запросов**, что облегчает:

* автодополнение в IDE
* типизацию (Python type checkers)
* написание и чтение кода
* обучение новичков

---

### 3. Жёсткая типизация и поддержка mypy/pyright

Версия 2.0 добавила **полноценные type hints**, что было невозможно в старом API.

#### Что типизировано:

* модели ORM (через `Mapped[]` и `mapped_column()`);
* отношения (`Mapped[List[Order]]`);
* колонки и типы данных (`Mapped[int]`, `Mapped[str]`);
* результаты запросов (`Result[T]`, `ScalarResult[T]`).

#### Зачем?

* стабильный и предсказуемый API;
* меньше ошибок в рантайме;
* упрощение работы в больших кодовых базах.

**Пример поля в 2.0:**

---

### 4. Новый Declarative API

Вместо старых `Column()` в атрибуте прямо класса — теперь гибкое и строго типизированное:

#### Было:

```python
id = Column(Integer, primary_key=True)
```

#### Стало:

```python
id: Mapped[int] = mapped_column(primary_key=True)
```

Преимущества:

* чёткие типы;
* меньше магии;
* читабельнее;
* лучше интеграция с IDE.

---

### 5. Новый Session API

Session стала работать *по правилам транзакций по умолчанию*.

#### Что изменилось:

* **session.begin()** используется в явном виде;
* auto-commit поведение удалено (это важная корректировка);
* `Session.execute(select(...))` — основной метод общения ORM и Core.

Теперь Session:

* предсказуема
* согласована с транзакционной моделью Core
* легче понимается теми, кто пишет SQL

---

### 6. Удаление концепций, признанных устаревшими

#### ❌ `session.query()`

#### ❌ "implicit" autocommit

#### ❌ "binds" (старый способ соединений)

#### ❌ часть старых декларативных способов объявлять модели

#### ❌ часть давно deprecated конструкций Core (старые Join/FromClause API)

Цель — чтобы API был компактным, современным, предсказуемым.

Совместимость временно и ограниченно ищё поддерживается.

---

### 7. Улучшенная производительность

SQLAlchemy 2.0 сделал ряд внутренних оптимизаций.

#### Где ускорилось:

* построение запросов (меньше промежуточных объектов);
* работа ORM маппера;
* компиляция SQL;
* eager-loading стратегий;
* работа ResultSet.

#### Насколько?

В зависимости от паттерна — от **10% до 50%** ускорения в ряде операций (по заявлениям автора проекта в release notes).

---

### 8. Async-стек стал полноценной частью архитектуры

Частичная совместимость с `asyncio` была добавлена в SQLAlchemy 1.4,  
но только в 2.0 стала официально поддерживаемой и стабильной.

Теперь:

* есть `AsyncSession`;
* async-движки для всех популярных БД;
* типизированные async-запросы;
* полный parity с sync API.

---

### 9. Более строгая модель транзакций

В 2.0:

* транзакция **всегда** начинается явно;
* Session не делает ничего «за спиной»;
* управление flush/commit стало яснее.

Это особенно важно для больших проектов и микросервисов.

---

### 10. Краткий итого изменений в SQLAlchemy 2.0

* единый современный стиль запросов (ORM = Core-подход)
* полный отказ от старых API
* строгая и удобная типизация
* новый декларативный стиль моделей
* новый Session API
* улучшения async
* повышение производительности
* более чистый, предсказуемый, безопасный код
* упрощение обучения и поддержки проекта

### Резюме

**SQLAlchemy 2.0 — это не просто «обновление», а фактически новое поколение архитектуры библиотеки.**
