## 1. Что такое SQLAlchemy?

**SQLAlchemy** — это популярная библиотека (ORM + Core) для работы с реляционными базами данных в Python.

Она предоставляет два уровня абстракции:

* **SQLAlchemy Core** 
  * низкоуровневый, 
  * декларативный конструктор SQL-выражений 
  * близкий к "чистому SQL".

* **SQLAlchemy ORM** 
  * высокоуровневый объектно-реляционный маппер, 
  * позволяющий работать с таблицами как с Python-классами
  * (почти как в Django ORM)

Основные преимущества:

* единый API для множества СУБД (PostgreSQL, MySQL, SQLite, Oracle и др.);
* гибкость: можно писать как полноценный ORM-код, так и "почти сырой" SQL;
* мощный маппинг, ленивые загрузки, отношения, транзакции, пулы соединений.

[https://docs.sqlalchemy.org/en/20/intro.html#installation](https://docs.sqlalchemy.org/en/20/intro.html#installation)

---

## 2. История

* Проект создан Майком Байером (Mike Bayer) в **2005** году.
* Первоначальная цель
  * сделать более мощную и гибкую альтернативу существующим ORM для Python (например, SQLObject).
* В **2010–2020-е** SQLAlchemy стал стандартом де-факто для работы с БД в Python.
* Версия **2.0**, выпущенная в 2023-м [существенно отличается от прежней](./theory_04__SQLAlchemy_2.0.md)  

---

## 3. Где используется SQLAlchemy?

SQLAlchemy не привязан к конкретному фреймворку и используется практически во всех современных Python-стэках.

### Веб-фреймворки

* Flask — через расширение *Flask-SQLAlchemy*; самый популярный вариант.
* FastAPI — рекомендуется как стандартный ORM-инструмент.
* Pyramid — исторически хорошо интегрирован.
* Falcon — используется в крупных производственных проектах.
* Quart — async-вариант Flask.

### Инструменты асинхронной экосистемы

* SQLModel — построен поверх SQLAlchemy; активно используется с FastAPI.
* Databases — использует SQLAlchemy Core для запросов.

### Вне веба

* ETL-проекты (Airflow, Luigi, Prefect).
* Скрипты для анализа данных и миграций (через Alembic — официальный инструмент миграций SQLAlchemy).
* Backend-сервисы, микросервисы, ML-пайплайны, внутренние корпоративные инструменты.

---

## 4. Основные подходы (составные части) SQLAlchemy

### 1. Суть подхода ORM

ORM в SQLAlchemy — это способ работать с данными **через Python-классы вместо SQL**.

#### 1.1. Ключевые идеи

* **Модели = классы**, строки таблицы = объекты.
* **Запросы через Python-выражения** (`select(User)` вместо SQL-строк).
* **Автоматическая сборка отношений** (`relationship()`).
* **Стратегии загрузки** (ленивая, жадная, подзапросом).

#### 1.2. Где удобен

* CRUD-операции.
* Работа с бизнес-логикой.
* Код, где важна связность объектов, а не SQL-детали.

#### 1.3. Особенность

ORM в SQLAlchemy всегда можно «пробить» до SQL-уровня, если нужен контроль.

---

### 2. Суть подхода Core

SQLAlchemy Core — это **конструктор SQL и низкоуровневый интерфейс** для взаимодействия с БД.

#### 2.1. Ключевые идеи

* Таблицы описываются как **Table()**, колонки — как объекты.
* Запросы — **структурированные SQL-выражения**, но в Python-синтаксисе.
* Транзакции, соединения, пулы — под полным контролем.
* SQL выражается **точно**, предсказуемо и прозрачно.

#### 2.2. Где удобен

* Высоконагруженные сервисы.
* Сложный SQL, аналитика, ETL.
* Нетипичные схемы, существующие БД.
* Когда ORM «мешает, а не помогает».

#### 2.3. Особенность

Core работает независимо от ORM — можно использовать только его.

---

### 3. Суть Alembic

**Alembic — это официальная система миграций SQLAlchemy.**

#### 3.1. Что делает

* ведёт **историю изменений схемы** БД;
* генерирует миграции (ручные или автогенерация);
* позволяет откатывать/накатывать версии;
* работает с любыми СУБД, поддерживаемыми SQLAlchemy.

#### 3.2. Зачем нужен

* синхронизация БД между разработчиками;
* безопасное развёртывание;
* развёртывания через CI/CD;
* документирование изменений схемы.

---

### 4. Можно ли работать без Alembic?

**Да, можно.**
SQLAlchemy сам по себе не требует Alembic.

Но — с нюансами:

#### 4.1. Когда можно без него

* прототипы и MVP;
* простые SQLite-проекты;
* однопользовательские/единственные окружения;
* если миграции делаются вручную (SQL-скрипты).

#### 4.2. Когда с ним лучше, чем без него

* командная работа;
* продакшен;
* частые изменения схемы;
* CI/CD или контейнеризация;
* крупные проекты, сложная БД.

**Фактически:**
Если проект живёт больше пары недель — Alembic становится крайне желателен.

---

### 5. Таким образом

* **ORM** — объектный, удобный подход для бизнес-логики и типичных CRUD.
* **Core** — точный SQL-контроль, идеален для сложных запросов и производительности.
* **Alembic** — система версионирования схемы. Работать можно и без неё, но только в самых простых сценариях.

