Этот блок посвящён теоретическим основам построения распределённых систем на Redis для обеспечения 
- горизонтального масштабирования, 
- высокой доступности 
- и обработки больших объёмов данных.

---

### Кластеризация и масштабирование в Redis

#### 1. Зачем нужна кластеризация?

- **Ограничения одиночного экземпляра Redis**:
  - Объём данных ограничен доступной оперативной памятью одного сервера.
  - Производительность чтения/записи ограничена мощностью одного CPU и сетевого интерфейса.
  - Отказ одного узла приводит к полной недоступности сервиса (`single point of failure`).
  
- **Цели кластеризации**:
  - Горизонтальное масштабирование (добавление узлов для увеличения объёма данных и производительности).
  - Автоматическое распределение данных между узлами (шардинг).
  - Обеспечение высокой доступности за счёт репликации внутри кластера.

#### 2. Архитектура Redis Cluster

- **Минимальная конфигурация**: 
  - Не менее 3 мастер-узлов (рекомендуется 6 узлов: 3 мастера + 3 слейва для отказоустойчивости).
  
- **Роли узлов**:
  - **Мастер-узлы** (masters): 
    - Принимают записи, 
    - владеют частью данных.
    
  - **Слейв-узлы** (replicas): 
    - Асинхронные реплики мастеров, 
    - используются для чтения и автоматического `failover`.
    - 
- **Отсутствие прокси**: 
  - Клиенты общаются напрямую с узлами кластера (`smart clients`).

#### 3. Шардинг данных: хэш-слоты

- **Количество слотов**: 
  - Фиксированное — 16384 хэш-слота.
  
- **Распределение ключей**:
  - Для каждого ключа вычисляется CRC16(key) mod 16384 → номер слота.

- **Распределение слотов по мастерам**:
  - Каждый мастер владеет диапазоном слотов.
  - При добавлении/удалении узлов происходит миграция слотов и связанных с ними ключей.

#### 4. Обработка запросов в кластере

- **Поведение клиента**:
  - Клиент отправляет команду на любой узел.
  - Если запрошенный слот обслуживается этим узлом — команда выполняется.
  - Если нет — узел возвращает ошибки MOVED или ASK с указанием правильного узла.
  
- **Перенаправления**:
  - **MOVED**: Постоянное перенаправление (клиент обновляет свою карту слотов).
  - **ASK**: Временное перенаправление (во время миграции слота).
  
- **Python-клиенты**:
  - `redis-py-cluster` (или встроенная поддержка в новых версиях redis-py) 
    - автоматически обрабатывает MOVED/ASK и поддерживает актуальную топологию кластера.

#### 5. Отказоустойчивость в кластере

- **Обнаружение отказов**:
  - Узлы обмениваются `PING/PONG` сообщениями (`gossip`-протокол).
  - При недоступности узла большинство мастеров голосуют за его маркировку как `FAILED`.
  
- **Failover**:
  - Один из слейвов мастера автоматически повышается до мастера.
  - Требуется кворум (большинство мастеров должны быть доступны).
  - Время failover обычно 10–30 секунд.
  
- **Требования к отказоустойчивости**:
  - Каждый мастер должен иметь хотя бы одного слейва.
  - Узлы должны быть распределены по разным физическим серверам/зонам.

#### 6. Ограничения и особенности операций в кластере

- **Мульти-ключевые операции**:
  - Разрешены только если все ключи принадлежат одному хэш-слоту (или используются hash tags).
  - Примеры ограниченных команд: 
    - `MGET/MSET` (если ключи в разных слотах), 
    - `SUNION`, 
    - `TRANSACTION` (если затрагивает несколько слотов).
    
- **Транзакции и Lua-скрипты**:
  - Поддерживаются, но только в пределах одного слота.
  
- **Кросс-слотовые операции**:
  - Требуют реализации на стороне приложения или использования сторонних инструментов.

#### 7. Масштабирование кластера

- **Добавление узлов**:
  - Новый узел присоединяется к кластеру (`CLUSTER MEET`).
  - Перераспределение слотов (`CLUSTER ADDSLOTS` или автоматическая перебалансировка).
  - Миграция ключей (`MIGRATE`).
  
- **Удаление узлов**:
  - Перераспределение слотов на другие мастера.
  - Удаление узла после полной миграции.
  
- **Автоматическая перебалансировка**:
  - Возможна с помощью утилиты `redis-cli --cluster rebalance`.

#### 8. Альтернативы и дополнения

- **Redis Enterprise**: 
  - Расширенные возможности кластеризации, 
  - актив-актив репликация (CRDT), 
  - бесконечное масштабирование.
  - 
- **Прокси-решения** (для упрощения работы клиента): 
  - Twemproxy, 
  - Envoy, 
  - Redis Sentinel (не для шардинга).

---

Этот блок даёт полное теоретическое понимание того,   
как Redis решает задачи масштабирования и отказоустойчивости в распределённой среде.   
